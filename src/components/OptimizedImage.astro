---
/**
 * Optimized Image component for better performance
 * Uses modern image formats, lazy loading, and proper sizing
 */
interface Props {
  src: string;
  alt: string;
  width: number;
  height: number;
  loading?: 'lazy' | 'eager';
  fetchpriority?: 'high' | 'low' | 'auto';
  class?: string;
  objectFit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
}

const {
  src,
  alt,
  width,
  height,
  loading = 'lazy',
  fetchpriority = 'auto',
  class: className = '',
  objectFit = 'cover'
} = Astro.props;

// Create responsive srcset for better performance
const createSrcSet = (url: string) => {
  if (!url.includes('unsplash.com')) return url;
  
  const widths = [400, 800, 1200, 1600];
  return widths
    .map(w => `${url}&w=${w} ${w}w`)
    .join(', ');
};

const srcset = createSrcSet(src);
const sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw';
---

<div class={`optimized-image-wrapper ${className}`} style={`aspect-ratio: ${width}/${height}`}>
  <img
    src={src}
    srcset={srcset}
    sizes={sizes}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    decoding="async"
    fetchpriority={fetchpriority}
    class={`optimized-image object-${objectFit}`}
  />
</div>

<style>
  .optimized-image-wrapper {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, theme('colors.base.200'), theme('colors.base.300'));
  }

  .optimized-image {
    width: 100%;
    height: 100%;
    transition: transform 0.3s ease;
    /* Better image rendering */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }

  /* Lazy load fade-in effect */
  .optimized-image[loading="lazy"] {
    opacity: 0;
    animation: fadeIn 0.5s ease-in forwards;
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  /* Hover effect */
  .optimized-image-wrapper:hover .optimized-image {
    transform: scale(1.05);
  }

  /* Loading state */
  .optimized-image-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.2) 50%,
      transparent 100%
    );
    animation: shimmer 2s infinite;
    pointer-events: none;
  }

  @keyframes shimmer {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  .optimized-image.loaded + ::before {
    display: none;
  }

  html[data-theme="dark"] .optimized-image-wrapper {
    background: linear-gradient(135deg, theme('colors.base.800'), theme('colors.base.900'));
  }
</style>

<script>
  // Add loaded class when image loads
  document.addEventListener('DOMContentLoaded', () => {
    const images = document.querySelectorAll('.optimized-image');
    images.forEach(img => {
      if ((img as HTMLImageElement).complete) {
        img.classList.add('loaded');
      } else {
        img.addEventListener('load', () => {
          img.classList.add('loaded');
        });
      }
    });
  });
</script>

