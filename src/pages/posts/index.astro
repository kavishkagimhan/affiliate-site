---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import Sidebar from '../../components/Sidebar.astro';
import { getCollection } from 'astro:content';

const postsPerPage = 9;
const allPosts = (await getCollection('posts'))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const currentPage = Number(Astro.url.searchParams.get('page')) || 1;
const totalPages = Math.ceil(allPosts.length / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const paginatedPosts = allPosts.slice(startIndex, endIndex);

// Get unique categories
const categories = [...new Set(allPosts.map((post) => post.data.category).filter(Boolean))];
---

<BaseLayout 
  title="Blog Posts | All Product Reviews"
  description="Browse all our product reviews, recommendations, and affiliate deals."
>
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <header class="mb-8">
          <h1 class="text-4xl font-bold mb-4">All Posts</h1>
          <p class="text-lg text-base-content/70">
            Discover the latest product reviews and recommendations
          </p>
        </header>

        <!-- Ad Container -->
        <div class="ad-container mb-8">
          <p class="text-sm text-base-content/60 mb-2">Advertisement</p>
        </div>

        <!-- Posts Grid -->
        {paginatedPosts.length > 0 ? (
          <>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              {paginatedPosts.map((post) => (
                <PostCard
                  title={post.data.title}
                  description={post.data.description}
                  image={post.data.image}
                  date={post.data.date}
                  category={post.data.category}
                  slug={post.slug}
                />
              ))}
            </div>

            <!-- Pagination -->
            {totalPages > 1 && (
              <div class="join flex justify-center mb-8">
                {currentPage > 1 && (
                  <a href={`/posts?page=${currentPage - 1}`} class="join-item btn">
                    Previous
                  </a>
                )}
                {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
                  <a
                    href={`/posts?page=${page}`}
                    class={`join-item btn ${page === currentPage ? 'btn-active' : ''}`}
                  >
                    {page}
                  </a>
                ))}
                {currentPage < totalPages && (
                  <a href={`/posts?page=${currentPage + 1}`} class="join-item btn">
                    Next
                  </a>
                )}
              </div>
            )}
          </>
        ) : (
          <div class="text-center py-16">
            <p class="text-xl text-base-content/70">No posts found.</p>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <aside class="lg:col-span-1">
        <Sidebar />
      </aside>
    </div>
  </div>
</BaseLayout>

